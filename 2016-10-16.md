---

title: test

date: 2017-03-11 13:47:53

tags: iOS

---



### 关于 CocoaPods 的一些实践分享

本文基于目前最新 `CocoaPods` 版本 1.2.1 。

#### CocoaPods 的一些基础知识

##### CocoaPods 是什么

众所周知，iOS 有许多第三方库，每次要使用这些第三方库时，总会给我们带来种种困扰，比如:

* 各种库自身配置也不尽相同并且有的十分繁琐，要加上很多奇怪的编译链接选项才能开心地跑起来。

* 第三方库版本管理完全靠文件替换，当要更改库版本，而库版本的一些配置依赖或配置发生变化时，简直酸爽上天。

* 一些库自身依赖了其他第三方库，使用的时候需要将这些依赖也一并下载下来安装。尤其当多个三方库又同时依赖某个库时，如何处理这些库的兼容问题又会让人非常抓狂。

CocoaPods 的出现，就是为了能让开发人员以一个比较简洁的方式去管理这些第三方库。使用 CocoaPods ，你只需要几步，就可以管理整个第三方库。

##### CocoaPods 的配置

* 安装 CocoaPods。
  打开终端，在终端输入：
  
  ```shell
  $ sudo gem install cocoapods
  ```
  
  安装完成后，输入以下命令可以查看下版本
  
  ```shell
  $ pod --version
  ```
  
  
* 在你喜欢的地方生成 CocoaPods 配置文件，并在配置文件中指定自身的项目工程文件的路径。
  在需要生成配置文件的目录下，终端输入：

  ```shell
  $ pod init
  ```

* 指定你需要的类库名 ( 绝大部分有名的开源类库都支持 CocoaPods ) , 以及需要的版本
  你可以使用以下命令来查询类库，以 AFNetworking 为例:
  
  ```shell
  $ pod search AFNetworking
  ```
  
* 在配置文件里填入所需第三方库

  ```shell
  target 'Project_Name' do
     pod 'AFNetworking'        
  end
  
  ```

* 保存配置文件，并在配置文件的目录下，输入命令

  ```shell
  $ pod install
  ```
  
  安装提示完成后，会生成一个 `.worksapce` 文件，打开这个文件，就可以在自己的工程里开心地使用这些第三方库了。整个过程 CocoaPods 代替我们完成了所有需要的工程配置。

  简单来说，使用 `CocoaPods` 只需要三个步骤：安装 `CocoaPods` ， 编写 `Podfile` ， 使用 `pod install` 命令。
  
  
#### CocoaPods 简单工作流程

  为了把整个流程原理描述清楚，我们新建初始的 `Single View Application` 工程，并尝试使用 `CocoaPods` 导入第三方库 `AFNetworking` 。
  
  简单配置一下：
  
  ```shell
  platform :ios, '9.0'
  target 'Demo' do
     pod 'AFNetworking'
  end
  ```
  
  
  使用 `pod install --verbose` 命令 ( 使用 `verbose` 选项可以打印出详细日志)
  
  ```shell
Preparing

Analyzing dependencies

Resolving dependencies of `Podfile`

Comparing resolved specification to the sandbox manifest
  A AFNetworking

Downloading dependencies

-> Installing AFNetworking (3.1.0)
 > Git download
 > Git download
     ···
     --template= --single-branch --depth 1 --branch 3.1.0
     Cloning into '/var/folders/l0/m1dm1rr14qn7q8f1nzkrwnnr0000gn/T/d20170529-2846-5es2qa'...
     ···
  - Running pre install hooks

Generating Pods project
  - Creating Pods project
  - Adding source files to Pods project
  - Adding frameworks to Pods project
  - Adding libraries to Pods project
  - Adding resources to Pods project
  - Linking headers
  - Installing targets
    - Installing target `AFNetworking` iOS 7.0
    - Installing target `Pods-Demo` iOS 10.2
  - Running post install hooks
  - Writing Xcode project file to `Pods/Pods.xcodeproj`
    - Generating deterministic UUIDs
  - Writing Lockfile in `Podfile.lock`
  - Writing Manifest in `Pods/Manifest.lock`

Integrating client project

[!] Please close any current Xcode sessions and use `Demo.xcworkspace` for this project from now on.

Integrating target `Pods-Demo` (`Demo.xcodeproj` project)
  Adding Build Phase '[CP] Embed Pods Frameworks' to project.
  Adding Build Phase '[CP] Copy Pods Resources' to project.
  Adding Build Phase '[CP] Check Pods Manifest.lock' to project.
  - Running post install hooks
    - cocoapods-stats from
    `/Library/Ruby/Gems/2.0.0/gems/cocoapods-stats-1.0.0/lib/cocoapods_plugin.rb`

Sending stats
      - AFNetworking, 3.1.0
  Pod installation complete! There is 1 dependency from the Podfile and 1 total
  pod installed.
  ```

其中，关键路径为如下几步:

* Analyzing & Downloading Dependencies , 一些准备工作，主要是下载第三方库的代码和依赖。
* Running pre install hooks , 执行由用户自定义的 `pre_install` 钩子方法。
* Generating Pods project
  * 创建 Pods 工程。
  * 将各种源文件，库，资源加入 Pods 工程。
  * 将每个依赖作为一个静态库类型 target ( 如果使用 use_framework! 关键字，则为动态库，以下雷同不再赘述 ) 输出。
  * 生成 Podfile.lock 文件用来锁定当前各依赖库的版本。
* Running post install hooks ， 执行由用户自定义的 `post_install` 钩子方法。
* Integrating client project ( 集成至用户工程 )
* Sending stats ( 打印出最后的集成状态结果 )


在生成 Pods 项目工程过程中，

* 每个依赖库会单独编译，生成不同的 lib.a 文件。各个 target 通过 Target.xcconfig 文件在编译时设置所有的依赖和参数。
* 工程自己会有一个名为 libPods.a 文件输出，通过 Pods.xcconfig 文件在编译时设置所有的依赖和参数。
* 对于 framework 形式输出的文件，CocoaPods 会剥去和主工程声明架构无关的代码 (strip invalid architectures) 以及重新签名 (code resign)。
* 对于资源文件，CocoaPods 提供了一个名为 Pods-resources.sh 的 bash 脚本，在每次编译的时候执行，将第三方库附带的各种资源文件复制到目标目录中。



依赖关系示意图

```
┌── Host Project                   
│   │
│   │                ┌─── Dependence Lib 1
│   │                │
│   └── App Product ─┼─── Dependence Lib 2                          
│                    │
│                    └─── CocoaPods Product
│                              │    
│                              │      
└── CocoaPods ─────────────────┼─── CocoaPods Dependence Lib 1
                               │      
                               │      
                               ├─── CocoaPods Dependence Lib 2
                               │
                               │
                               └─── CocoaPods Dependence Lib 3
```


#### CocoaPods 私有化

随着公司项目的逐渐发展，会涉及到多模块甚至多 App 并行开发， 公共代码模块化，组件库复用成为了大势所趋。
我们可以通过 CocoaPods 提供的管理能力将这些基础业务等同于其他第三方库一并管理，但同时，我们不希望这些公司内部的代码提供给别人。这个时候，我们可以制作 CocoaPods [私有库](https://guides.cocoapods.org/making/private-cocoapods.html) 来解决这个问题。

##### 私有化步骤

* 建立私有化仓库
  如同 CocoaPods [公有仓库](https://github.com/CocoaPods/Specs) 一样，私有化的 Pods 也需要一个地方存放私有仓库的 .podspec 文件。建立仓库命令

  ```shell
  pod repo add 'repo_name' 'repo_address'  
  ```

  其中 repo_address 为私有化仓库地址，通常是搭建在内网里头的 git 仓库地址。

  建立成功之后，可以通过 `~/.cocoapods/repos` 目录进行查看。

* 建立 pod 仓库描述文件 `x.podspec` ， 这里的步骤和建立公有仓库一致，不再赘述。

* 将描述文件 `x.podspec` 推送至私有 Pods 仓库

  ```shell
  pod repo push 'repo_name' x.podspec
  ```

* 其他开发成员使用私有库时，需要在 podfile 中声明 source 参数，将私有化仓库 ( 即上述 repo_address ) 声明即可。

  例如:

  ```shell    
    # 公有仓库
    source 'https://github.com/CocoaPods/Specs.git'  
    # 私有仓库
    source 'repo_address'

    
    target 'Project_Name' do
      pod 'repo_name'        
    end

  ```

#### CocoaPods 开发模式

在实际开发中，无法

### CocoaPods 行为定制

当有些业务场景，CocoaPods 不能完全满足业务，这个时候需要自定义一些行为去满足我们的需求。

观察上述工作流程，可以发现 CocoaPods 在生成工程的前后，分别会去执行 `pre_install`  以及 `post_install` ，我们只需要在 Pod File 中定义这两个方法即可。

场景